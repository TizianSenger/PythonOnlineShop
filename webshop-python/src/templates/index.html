{% extends "base.html" %}

{% block title %}WebShop{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Willkommen im WebShop</h1>

    <form method="GET" class="card" style="margin-bottom:1rem; display:flex; gap:0.5rem; align-items:center;">
        <input name="q" placeholder="Suche..." value="{{ request.args.get('q','') }}" style="flex:1; padding:0.6rem;">
        <select name="category" style="width:180px; padding:0.6rem;">
            <option value="">Alle Kategorien</option>
            {% for c in categories %}
            <option value="{{ c }}" {% if request.args.get('category')==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <input name="min_price" placeholder="min ‚Ç¨" value="{{ request.args.get('min_price','') }}"
            style="width:90px; padding:0.6rem;">
        <input name="max_price" placeholder="max ‚Ç¨" value="{{ request.args.get('max_price','') }}"
            style="width:90px; padding:0.6rem;">
        <button class="btn btn-primary" type="submit">Filtern</button>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <h2 class="mb-3">Unsere Produkte</h2>
    <div class="grid grid-2">
        {% for product in products %}
        <div class="card product-card">
            <a href="/product/{{ product.id }}" style="text-decoration: none; color: inherit;">
                <div class="product-image"
                    style="background-size:cover; background-position:center;{% if product.main_image %}background-image:url('{{ url_for('static', filename='uploads/' ~ product.main_image) }}');{% endif %}">
                    {% if not product.main_image %}üì¶{% endif %}
                </div>
                <h3 class="product-name">{{ product.name }}</h3>
                <p class="product-description">{{ product.description or 'Keine Beschreibung verf√ºgbar' }}</p>
                {% if product.category %}
                <p class="text-muted mb-2"><small>Kategorie: {{ product.category }}</small></p>
                {% endif %}
                <p class="product-price">‚Ç¨ {{ product.price }}</p>
                <p class="text-muted">Auf Lager: {{ product.stock or '0' }} | üñºÔ∏è {{ (product.images|length if
                    product.images else 0) }}</p>
            </a>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <input type="number" id="qty-{{ product.id }}" value="1" min="1" style="width:60px; padding:0.5rem;">
                <button class="btn btn-primary" onclick="addToCart('{{ product.id }}', this)">In den
                    Warenkorb</button>
            </div>
        </div>
        {% else %}
        <div class="text-center">
            <p class="text-muted">Noch keine Produkte verf√ºgbar.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function addToCart(productId, btn) {
        const qtyInput = document.getElementById('qty-' + productId);
        const quantity = qtyInput ? Math.max(1, parseInt(qtyInput.value) || 1) : 1;
        fetch('/add-to-cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: productId, quantity: quantity })
        })
            .then(res => res.json())
            .then(data => {
                if (data && data.success) {
                    const countEl = document.getElementById('cart-count');
                    if (countEl) countEl.textContent = data.cart_count;
                    flashButton(btn);
                    showToast(`${quantity} Artikel hinzugef√ºgt! üõí`, 'success');
                } else if (data && data.error) {
                    // Benutzer muss sich einloggen
                    showDialog(data.error, 'error', () => {
                        window.location.href = '/login';
                    });
                }
            })
            .catch(err => console.error(err));
    }
    function flashButton(btn) {
        if (!btn) return;
        btn.classList.add('btn-flash');
        setTimeout(() => btn.classList.remove('btn-flash'), 600);
    }
    function showToast(message, type = 'success') {
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†' };
        toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><div class="toast-content"><p class="toast-message">${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('closing');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}